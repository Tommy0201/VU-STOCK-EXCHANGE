<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Hello, {{ username }}</h1>
        <h2>Available Stocks</h2>
        <select id="stockSelect" onchange="updateGraph()">
            {% for symbol, data in stocks.items() %}
                <option value="{{ symbol }}">{{ symbol }}</option>
            {% endfor %}
        </select>
        <canvas id="stockChart" width="800" height="400"></canvas>
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Company Name</th>
                    <th>Price</th>
                    <th>Volume</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for symbol, data in stocks.items() %}
                <tr>
                    <td>{{ symbol }}</td>
                    <td>{{ data['company_name'] }}</td>
                    <td>${{ data['price'] }}</td>
                    <td>{{ data['volume'] }}</td>
                    <td>
                        <form action="{{ url_for('buy', symbol=symbol) }}" method="POST">
                            <input type="number" name="volume" min="1" max="{{ data['volume'] }}" required>
                            <button type="submit">Buy</button>
                        </form>
                        <form action="{{ url_for('sell', symbol=symbol) }}" method="POST">
                            <input type="number" name="volume" min="1" required>
                            <button type="submit">Sell</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p><a href="{{ url_for('logout') }}">Logout</a></p>
    </div>
    <script>
        var ctx = document.getElementById('stockChart').getContext('2d');
        var stockChart;

        function updateGraph() {
            var selectedStock = document.getElementById('stockSelect').value;
            var stockData = {
                labels: [],
                datasets: [{
                    label: 'Price',
                    data: [],
                    fill: false,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }]
            };

            // Add real-time prices data for the selected stock
            {% for symbol, data in stocks.items() %}
            if ("{{ symbol }}" === selectedStock) {
                stockData.labels.push("{{ data['company_name'] }}");
                stockData.datasets[0].data.push({{ data['price'] }});
            }
            {% endfor %}

            if (stockChart) {
                stockChart.destroy();
            }

            stockChart = new Chart(ctx, {
                type: 'line',
                data: stockData,
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: false
                            }
                        }]
                    }
                }
            });
        }

        setInterval(updateGraph, 5000); // Update graph every 5 seconds
        updateGraph(); // Initial update
    </script>
</body>
</html>
